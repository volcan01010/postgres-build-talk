<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="description" content="Presentation slides for PostgreSQL Build, December 2021">
		<meta name="author" content="Dr John A Stevenson">

		<title>How many Postgres is too many?</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/bgs.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
<section>
	<section>
		<h4>How many Postgres is too many?</h4>
		<p><span class="small">An infrastructure-as-code approach to PostgreSQL-backed IoT sensor data sharing</span></p>
		<p>
		<span class="small"><a href="https://twitter.com/volcan01010">Dr John A Stevenson</a> / <a href="https://twitter.com/volcan01010">@volcan01010</a></span>
		</p>
		<a href="https://www.bgs.ac.uk"><img src="https://resources.bgs.ac.uk/images/BGS-Logo-Pos-RGB.svg" width=400 style="background:white; border:15px solid white; box-shadow:none;"></a>
		<aside data-markdown class="notes">
		The aim of this talk is to describe architecture of BGS Sensor Data Service and some of the features/tools that we used to create it.
		</aside>
	</section>
	<section data-markdown>
		+ Background
		+ Single server configuration
		+ Multi-environments and replication
		+ Questions
		<aside data-markdown class="notes">
		The aim of this talk is to describe architecture of BGS Sensor Data Service and some of the features/tools that we used to create it.
		</aside>
	</section>
</section>

<section>
	<section>
		<h4>About BGS</h4>
		<blockquote>"Our mission is to provide impartial and independent geoscience advice and data."</blockquote>
		<ul>
		<li>Work with academics, governments, industry and the public</li>
		<li>Digital division has 10 years of making digital data available e.g. via <a href="http://onegeology.org/">OneGeology</a> and <a href="https://www.bgs.ac.uk/geological-data/opengeoscience/">OpenGeoscience Portal</a>
		and contributions to standards for data sharing e.g. <a href="https://www.bgs.ac.uk/news/geosciml-data-standard-becomes-official/">GeoSciML</a></li>
		</ul>
	<aside data-markdown class="notes">
		650 staff, 70 in Digital are professional software developers and database experts.
	</aside>
	</section>

	<section>
		<h4>BGS IT Infrastructure</h4>

		<p>Self-hosted</p>
	<aside data-markdown class="notes">
		Supply chain attacks injecting Bitcoin miners or ransomware are a worry.
	</aside>
	</section>

	<section>
		<img class="stretch" src="images/glasgow_main_mine_working.png">
		<a href="https://ukgeos.ac.uk/observatories/glasgow">UK Geoenergy Observatories</a>
	<aside data-markdown class="notes">
		Change comes from the senior developer level as they are using the code day-to-day.
		BGS hired senior developers with explicit interest in open source software.
	</aside>
	</section>

	<section>
		<img class="stretch" src="images/sensor_data_graph.png">
		<a href="https://sensors.bgs.ac.uk">sensors.bgs.ac.uk</a>

	<aside data-markdown class="notes">
		Change comes from the senior developer level as they are using the code day-to-day.
		BGS hired senior developers with explicit interest in open source software.
	</aside>
	</section>
</section>

<section>
	<section data-background-size="contain" data-background="images/001_just_postgres.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		<pre><code data-trim data-line-numbers="2,10,11,13,21,25,26">
services:
  db:
    image: .../frost-db:${FROST_DB_TAG}
    ...
    environment:
      POSTGRES_DB: frost_db
      POSTGRES_USER: ${FROST_DB_USER}
      POSTGRES_PASSWORD: ${FROST_DB_PASSWORD}
    ...
    volumes:
      - postgis_data:/var/lib/postgresql/data

  frost:
    image: .../frost-server:${FROST_API_TAG}
    ...
    environment:
      ...
      - persistence_db_url=jdbc:postgresql://db:5432/frost_db
      - persistence_db_username=${FROST_DB_USER}
      - persistence_db_password=${FROST_DB_PASSWORD}
    command: ["/wait_for_postgis.sh", "catalina.sh", "run"]
    depends_on:
      - db

volumes:
  postgis_data:
		</code></pre>
	</section>

	<section data-background-size="contain" data-background="images/001_just_postgres.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/002_single_vm.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		docker-compose.yml
	</section>

	<section>
		Wait for postgresql.sh
	</section>

	<section data-background-size="contain" data-background="images/002_single_vm.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/003_single_vm_and_etl.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section data-markdown>
		<textarea data-template>
```bash65chars

             ----------------------------------
            |       pip install etlhelper      |
             ----------------------------------
                   \   ^__^
                    \  (oo)\_______
                       (__)\       )\/\
                           ||----w |
                           ||     ||


```
		</textarea>
	</section>
</section>

<section>
	<section data-background-size="contain" data-background="images/003_single_vm_and_etl.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/004_add_environments.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		logs in the database, docker-compose for command lines options
	</section>

	<section data-background-size="contain" data-background="images/004_add_environments.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/005_integration_test.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		Flyway to add jobs table; extra database for integration tests
	</section>
	
	<section data-background-size="contain" data-background="images/005_integration_test.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/006_add_replication.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		pglogical filters
	</section>

	<section data-background-size="contain" data-background="images/006_add_replication.png">
	</section>
	<section data-transition="fade-in" data-background-size="contain" data-background="images/007_replication_test.png">
	<aside data-markdown class="notes">
	</aside>
	</section>

	<section>
		Duplicate running databases
	</section>
</section>

<section>
	<section>
	Is nine Postgres too many?
	</section>
	<section>
	Questions
	</section>
</section>

	</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				width: 1152,
				height: 840,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
